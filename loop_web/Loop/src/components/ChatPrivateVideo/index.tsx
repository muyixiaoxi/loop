import React, { useEffect, useRef, useState } from "react";
import "./index.scss";

// 定义组件属性接口
interface ChatPrivateVideoProps {
  localStream: MediaStream | null; // 本地视频流
  remoteStream: MediaStream | null; // 远程视频流
  onClose: () => void; // 关闭视频通话回调
}

const ChatPrivateVideo: React.FC<ChatPrivateVideoProps> = ({
  localStream,
  remoteStream,
  onClose,
}) => {
  // 视频元素引用
  const localVideoRef = useRef<HTMLVideoElement>(null);
  const remoteVideoRef = useRef<HTMLVideoElement>(null);

  // 控制状态
  const [isMuted, setIsMuted] = useState(false); // 是否静音
  const [isVideoOff, setIsVideoOff] = useState(false); // 是否关闭视频

  // 监听本地视频流变化，设置到video元素
  // 添加useEffect监听流变化
  useEffect(() => {
    if (remoteVideoRef.current) {
      if (remoteStream) {
        // console.log("设置远程视频流", remoteStream.getTracks());
        remoteVideoRef.current.srcObject = remoteStream;
      }
    }

    if (localVideoRef.current) {
      if (localStream) {
        // console.log("设置本地视频流", localStream.getTracks());
        localVideoRef.current.srcObject = localStream;
      }
    }
  }, [remoteStream, localStream]);

  // 切换静音状态
  const toggleMute = () => {
    if (localStream) {
      localStream.getAudioTracks().forEach((track) => {
        track.enabled = !track.enabled; // 切换音频轨道启用状态
      });
      setIsMuted(!isMuted); // 更新状态
    }
  };

  // 切换视频状态
  const toggleVideo = () => {
    if (localStream) {
      localStream.getVideoTracks().forEach((track) => {
        track.enabled = !track.enabled; // 切换视频轨道启用状态
      });
      setIsVideoOff(!isVideoOff); // 更新状态
    }
  };

  return (
    <div className="video-chat-container">
      {/* 视频显示区域 */}
      <div className="video-wrapper">
        {/* 远程视频 */}
        <video
          ref={remoteVideoRef}
          autoPlay // 自动播放
          playsInline // 内联播放(移动端兼容)
          className="remote-video"
        />
        {/* 本地视频(小窗) */}
        <video
          ref={localVideoRef}
          autoPlay
          playsInline
          muted // 本地视频默认静音避免回声
          className="local-video"
        />
      </div>

      {/* 控制按钮区域 */}
      <div className="control-buttons">
        {/* 静音/取消静音按钮 */}
        <button
          onClick={toggleMute}
          className={`control-button ${isMuted ? "muted" : ""}`}
        >
          {isMuted ? (
            <svg
              viewBox="0 0 1281 1024"
              version="1.1"
              xmlns="http://www.w3.org/2000/svg"
              p-id="17960"
              width="25.5"
              height="28"
            >
              <path
                d="M1280.520108 925.924402L60.386284 82.170843l-52.11419 82.720937 104.228381 72.794425h-20.680235A90.993031 90.993031 0 0 0 0 327.024817v369.762589a91.82024 91.82024 0 0 0 91.82024 90.993031h183.640481l294.486536 220.864903c40.533259 30.606747 73.621634 14.062559 73.621634-37.224422V604.139957l133.180709 92.647449a67.003959 67.003959 0 0 0 100.092334 69.485588l118.290941 82.720937-4.136047 4.963256a68.989262 68.989262 0 1 0 97.610706 97.610706c7.444884-7.444884 13.23535-15.716978 19.853025-23.989072l121.599777 82.720937zM643.568891 52.391306c0-50.459772-33.088375-67.831169-73.621634-37.224422L344.946308 181.435968l297.795374 206.802343zM852.852863 536.308788l121.599777 82.720937a343.291889 343.291889 0 0 0-82.720937-352.391192 68.658378 68.658378 0 0 0-94.301868 99.265125 205.975134 205.975134 0 0 1 55.423028 170.40513zM1091.916371 702.577872l114.982103 82.720937A620.407029 620.407029 0 0 0 1087.780324 76.380377a68.989262 68.989262 0 0 0-97.610706 97.610706 482.263064 482.263064 0 0 1 101.746753 528.586789z"
                fill="#1E1E1E"
                p-id="17961"
              ></path>
            </svg>
          ) : (
            <svg
              viewBox="0 0 1443 1024"
              version="1.1"
              xmlns="http://www.w3.org/2000/svg"
              p-id="16808"
              width="30"
              height="30"
            >
              <path
                d="M979.341365 270.884775c-26.9276-26.756086-70.320483-26.756086-97.07657 0-26.756086 26.9276-26.756086 70.320483 0 97.07657 80.611286 80.439772 80.611286 210.96145 0 291.572736-26.756086 26.9276-26.756086 70.320483 0 97.076569 26.9276 26.756086 70.320483 26.756086 97.07657 0 133.951945-134.123458 133.951945-351.602416 0-485.725875zM1171.093317 72.443802c-26.756086-26.756086-70.320483-26.756086-97.07657 0-26.756086 26.756086-26.756086 70.320483 0 97.076569 187.807144 187.978658 187.807144 492.414896 0 680.393555-26.756086 26.9276-26.756086 70.320483 0 97.076569 26.9276 26.756086 70.320483 26.756086 97.07657 0 241.319317-241.49083 241.319317-632.88435 0-874.546693zM655.009575 14.986821L361.893219 235.03848H178.373909l-0.171514-0.171513c-6.174481 0-12.17745 0.171513-18.180417 0.171513-38.418996 0-73.236211 46.480124-73.236211 90.559062v368.239213c0 49.395852 40.991696 90.902088 91.416628 90.902088h183.347797L654.666548 1004.618989c40.820183 30.529381 73.236211 13.892583 73.236211-36.875376v-42.19229l0.171513 0.343027V51.862197c0.171513-50.081905-32.759054-67.061729-73.064697-36.875376z"
                p-id="16809"
              ></path>
            </svg>
          )}
        </button>

        {/* 开启/关闭视频按钮 */}
        <button
          onClick={toggleVideo}
          className={`control-button ${isVideoOff ? "video-off" : ""}`}
        >
          {isVideoOff ? (
            <svg
              viewBox="0 0 1024 1024"
              version="1.1"
              xmlns="http://www.w3.org/2000/svg"
              p-id="8129"
              width="30"
              height="30"
            >
              <path
                d="M73.130667 12.501333l938.666666 938.666667a42.666667 42.666667 0 0 1-60.330666 60.330667l-236.032-235.989334A128 128 0 0 1 597.632 853.333333h-469.333333a128 128 0 0 1-128-128V298.666667l0.213333-7.509334a128 128 0 0 1 111.189333-119.424L12.8 72.832A42.666667 42.666667 0 1 1 73.130667 12.501333zM195.925333 256H128.298667l-4.992 0.298667A42.666667 42.666667 0 0 0 85.632 298.666667v426.666666l0.298667 4.992a42.666667 42.666667 0 0 0 42.368 37.674667h469.333333a42.666667 42.666667 0 0 0 42.666667-42.666667v-24.96L195.925333 256z m401.706667 0h-142.506667V170.666667h142.506667a128 128 0 0 1 128 128v124.8l4.437333 4.437333 226.56-163.84 25.002667 34.602667h42.666667v426.666666l-0.298667 4.992A42.666667 42.666667 0 0 1 938.965333 725.333333V382.165333l-188.330666 136.234667a42.666667 42.666667 0 0 1-55.168-4.394667l-42.666667-42.666666-3.712-4.224a42.666667 42.666667 0 0 1-8.789333-25.941334V298.666667a42.666667 42.666667 0 0 0-42.666667-42.666667z m358.997333 8.106667a42.666667 42.666667 0 0 1 67.669334 34.56h-42.666667zM455.125333 170.666667v85.333333a42.666667 42.666667 0 1 1 0-85.333333z"
                p-id="8130"
              ></path>
            </svg>
          ) : (
            <svg
              viewBox="0 0 1024 1024"
              version="1.1"
              xmlns="http://www.w3.org/2000/svg"
              p-id="22425"
              width="30"
              height="30"
            >
              <path
                d="M1021.1328 340.3776c-0.2048-27.1872-15.5136-51.712-39.9872-64.1024a73.8816 73.8816 0 0 0-75.8272 5.4272L720.384 411.6992v-127.488c0-59.3408-48.6912-107.5712-108.5952-107.5712H108.6464C48.7424 176.64 0 224.9216 0 284.2112v455.5264c0 59.3408 48.7424 107.6224 108.6464 107.6224h503.0912c59.904 0 108.6464-48.2816 108.6464-107.5712v-150.8352l185.856 140.0832c22.1696 16.6912 52.48 19.456 77.2608 7.1168 24.832-12.288 40.7552-38.0416 40.5504-65.5872l-2.8672-330.24zM947.8144 665.6l-220.4672-166.1952 217.6512-153.0368 2.816 319.1808z m-303.5648-381.3376v455.5264c0 17.7152-14.592 32.1024-32.512 32.1024H108.6464c-17.92 0-32.512-14.3872-32.512-32.1024V284.2112c0-17.7152 14.592-32.1024 32.512-32.1024h503.0912c17.92 0 32.512 14.3872 32.512 32.1024z"
                p-id="22426"
              ></path>
            </svg>
          )}
        </button>

        {/* 结束通话按钮 */}
        <button onClick={onClose} className="end-call-button">
          <svg
            viewBox="0 0 1024 1024"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
            p-id="2436"
            width="30"
            height="30"
          >
            <path
              d="M0 511.573689c0 182.461282 97.199001 351.2806 255.786844 443.363863s352.985845 92.083264 511.573689 0 255.786844-260.902581 255.786844-443.363863C1023.147377 228.502914 794.644463 0 511.573689 0S0 228.502914 0 511.573689z"
              fill="#BD0000"
              p-id="2437"
            ></path>
            <path
              d="M511.573689 485.995004c75.030808 0 155.177352 6.820983 155.177352 42.631141 0 49.452123-6.820983 86.967527 92.083264 97.199001 97.199001 10.231474 85.262281-61.388843 85.262281-109.135721 0-54.56786-129.598668-133.009159-332.522897-131.303913s-332.522898 78.441299-330.817652 133.009159c0 47.746878-11.936719 119.367194 85.262281 109.13572 98.904246-10.231474 92.083264-47.746878 92.083264-97.199-1.705246-37.515404 78.441299-44.336386 153.472107-44.336387"
              fill="#FFFFFF"
              p-id="2438"
            ></path>
          </svg>
        </button>
      </div>
    </div>
  );
};

export default ChatPrivateVideo;
